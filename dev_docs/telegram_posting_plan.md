# План: Постинг в Telegram

**Дата:** 2025-12-01  
**Версия:** 1.0  
**Статус:** Draft

---

## 1. Обзор

Данный документ описывает детальный план реализации постинга в Telegram с поддержкой автоматического определения типа сообщения и расширенными медиа-возможностями.

---

## 2. Новые поля и типы

### 2.1. Добавление типа `auto`

**Описание:**  
Добавить новый тип поста `auto`, который будет значением по умолчанию для всех социальных сетей.

**Изменения в коде:**
- Добавить `AUTO = 'auto'` в enum `PostType` (`src/common/enums/post-type.enum.ts`)
- Установить `auto` как значение по умолчанию в DTO
- Обновить документацию (PRD.md, api.md)

**Поведение:**  
Для каждой социальной сети `auto` означает разную логику автоматического определения типа. Для Telegram — см. раздел 3.

---

### 2.2. Добавление полей `audio` и `document`

**Описание:**  
Добавить поля `audio` и `document` для социальных сетей, которые поддерживают эти типы медиа (включая Telegram).

**Изменения в коде:**

В `PostRequestDto` (`src/modules/post/dto/post-request.dto.ts`):

```typescript
@IsOptional()
@IsUrl()
audio?: string;

@IsOptional()
@IsUrl()
attachment?: string;  // Альтернативное название для document
```

**Примечание:**  
- `audio` - URL аудио-файла
- `attachment` (или `document`) - URL любого файла/документа
- Поля опциональные и валидируются как URL

**Поддержка:**
- ✅ Telegram - поддерживает оба типа
- ✅ VK - поддерживает оба типа  
- ✅ Discord - поддерживает attachments
- ❌ Instagram - не поддерживает
- ❌ Twitter/X - ограниченная поддержка

---

## 3. Логика автоматического определения типа для Telegram (type: auto)

### 3.1. Приоритет проверок

Когда `type = 'auto'` (или не указан), система должна автоматически определить метод отправки сообщения в Telegram, выполняя проверки в следующем порядке:

```
1. media[]       → Медиа-группа (sendMediaGroup)
2. attachment    → Приложенный файл (sendDocument)  
3. audio         → Аудио-сообщение (sendAudio)
4. video         → Видео-сообщение (sendVideo)
5. cover         → Сообщение-картинка (sendPhoto)
6. [нет медиа]   → Текстовое сообщение (sendMessage)
```

### 3.2. Детальное описание логики

#### 1. Проверка наличия `media` (медиа-группа)

**Условие:** `media && media.length > 0`

**Действие:**
- Использовать метод `sendMediaGroup` из Telegram Bot API
- `body` используется как `caption` для первого элемента группы
- Игнорируются: `cover`, `video`, `audio`, `attachment`
- Ограничение: максимум 10 элементов в группе

**Пример запроса:**
```json
{
  "platform": "telegram",
  "type": "auto",
  "body": "Описание альбома",
  "media": [
    "https://example.com/photo1.jpg",
    "https://example.com/photo2.jpg",
    "https://example.com/video.mp4"
  ]
}
```

---

#### 2. Проверка наличия `attachment` (приложенный файл)

**Условие:** `attachment && !media`

**Действие:**
- Использовать метод `sendDocument` из Telegram Bot API
- `body` используется как `caption`
- Игнорируются: `cover`, `video`, `audio`
- Поддерживаются любые типы файлов (PDF, DOC, ZIP и т.д.)
- Максимальный размер: 50 МБ

**Пример запроса:**
```json
{
  "platform": "telegram",
  "type": "auto",
  "body": "Вот документ",
  "attachment": "https://example.com/report.pdf"
}
```

---

#### 3. Проверка наличия `audio` (аудио-сообщение)

**Условие:** `audio && !media && !attachment`

**Действие:**
- Использовать метод `sendAudio` из Telegram Bot API
- `body` используется как `caption`
- Игнорируются: `cover`, `video`
- Telegram отображает плеер для аудио
- Поддерживаемые форматы: MP3, M4A, OGG
- Максимальный размер: 50 МБ

**Пример запроса:**
```json
{
  "platform": "telegram",
  "type": "auto",
  "body": "Новый подкаст",
  "audio": "https://example.com/podcast.mp3"
}
```

---

#### 4. Проверка наличия `video` (видео-сообщение)

**Условие:** `video && !media && !attachment && !audio`

**Действие:**
- Использовать метод `sendVideo` из Telegram Bot API
- `body` используется как `caption`
- Игнорируется: `cover`
- Поддерживаемые форматы: MP4, MOV
- Максимальный размер: 50 МБ

**Пример запроса:**
```json
{
  "platform": "telegram",
  "type": "auto",
  "body": "Видео инструкция",
  "video": "https://example.com/tutorial.mp4"
}
```

---

#### 5. Проверка наличия `cover` (сообщение-картинка)

**Условие:** `cover && !media && !attachment && !audio && !video`

**Действие:**
- Использовать метод `sendPhoto` из Telegram Bot API
- `body` используется как `caption`
- Поддерживаемые форматы: JPG, PNG, WEBP
- Максимальный размер: 10 МБ

**Пример запроса:**
```json
{
  "platform": "telegram",
  "type": "auto",
  "body": "Красивая картинка",
  "cover": "https://example.com/image.jpg"
}
```

---

#### 6. Текстовое сообщение (по умолчанию)

**Условие:** нет `cover`, `video`, `audio`, `attachment`, `media`

**Действие:**
- Использовать метод `sendMessage` из Telegram Bot API
- Отправляется только `body`
- Максимальная длина: 4096 символов

**Пример запроса:**
```json
{
  "platform": "telegram",
  "type": "auto",
  "body": "Текстовое сообщение без медиа"
}
```

---

### 3.3. Таблица приоритетов (для быстрого понимания)

| Медиа-поля                                      | Метод Telegram API | Игнорируемые поля                  |
|-------------------------------------------------|--------------------|------------------------------------|
| `media[]`                                       | sendMediaGroup     | cover, video, audio, attachment    |
| `attachment` (без media)                        | sendDocument       | cover, video, audio                |
| `audio` (без media, attachment)                 | sendAudio          | cover, video                       |
| `video` (без media, attachment, audio)          | sendVideo          | cover                              |
| `cover` (без media, attachment, audio, video)   | sendPhoto          | -                                  |
| нет медиа                                       | sendMessage        | -                                  |

---

## 4. Использование поля `body` для медиа-сообщений

**Важно:**  
Для всех типов медиа-сообщений (фото, видео, аудио, документ, медиа-группа) поле `body` используется как `caption` (подпись к медиа).

**Ограничения caption в Telegram:**
- Максимальная длина: 1024 символа
- Поддерживаются те же форматы разметки, что и для обычных сообщений (HTML, Markdown)

**Обработка:**
- Если `body.length > 1024`, необходимо обрезать или вернуть ошибку валидации
- Применяется конвертация формата (если `convertBody = true`)

---

## 5. Неиспользуемые поля для Telegram

Следующие поля **не используются** и **игнорируются** для Telegram:

| Поле           | Причина                                                   |
|----------------|-----------------------------------------------------------|
| `title`        | Telegram не поддерживает отдельные заголовки              |
| `description`  | Telegram не имеет поля описания (используется только body)|
| `postLanguage` | Telegram не требует указания языка контента               |
| `tags`         | Telegram не имеет встроенной системы тегов (хештеги можно добавить в body) |
| `mode`         | Telegram не поддерживает черновики через Bot API          |

**Рекомендация:**  
При валидации для Telegram можно выводить предупреждение (warning), если эти поля заданы, но они будут проигнорированы.

---

## 6. Явное указание типа поста (валидация)

### 6.1. Общие правила

Если поле `type` **явно задано** (не `auto`), система должна:
1. Валидировать данные именно для этого типа поста
2. Проверить наличие требуемых полей
3. Вернуть ошибку валидации, если данные не соответствуют типу

### 6.2. Поддерживаемые типы для Telegram

#### `post` - текстовое сообщение

**Требования:**
- `body` обязательно
- Медиа-поля (`cover`, `video`, `audio`, `attachment`, `media`) должны отсутствовать

**Валидация:**
- Если есть медиа-поля → вернуть ошибку: `"For type 'post', media fields must not be provided"`
- Если `body.length > 4096` → вернуть ошибку: `"Text message exceeds maximum length of 4096 characters"`

**Метод API:** `sendMessage`

---

#### `image` - сообщение-картинка

**Требования:**
- `cover` обязательно
- Остальные медиа-поля игнорируются

**Валидация:**
- Если `cover` отсутствует → вернуть ошибку: `"Field 'cover' is required for type 'image'"`
- Если есть `media`, `video`, `audio`, `attachment` → **предупреждение** (они будут проигнорированы)

**Метод API:** `sendPhoto`

---

#### `album` - медиа-группа

**Требования:**
- `media` обязательно, должно содержать от 2 до 10 элементов
- Остальные медиа-поля игнорируются

**Валидация:**
- Если `media` отсутствует или пустой → вернуть ошибку: `"Field 'media' is required for type 'album'"`
- Если `media.length < 2` → вернуть ошибку: `"Album must contain at least 2 media items"`
- Если `media.length > 10` → вернуть ошибку: `"Album cannot contain more than 10 media items"`
- Если есть `cover`, `video`, `audio`, `attachment` → **предупреждение** (они будут проигнорированы)

**Метод API:** `sendMediaGroup`

---

#### `video` - видео-сообщение

**Требования:**
- `video` обязательно
- Остальные медиа-поля игнорируются

**Валидация:**
- Если `video` отсутствует → вернуть ошибку: `"Field 'video' is required for type 'video'"`
- Если есть `media`, `cover`, `audio`, `attachment` → **предупреждение** (они будут проигнорированы)

**Метод API:** `sendVideo`

---

#### `audio` - аудио-сообщение

**Требования:**
- `audio` обязательно
- Остальные медиа-поля игнорируются

**Валидация:**
- Если `audio` отсутствует → вернуть ошибку: `"Field 'audio' is required for type 'audio'"`
- Если есть `media`, `cover`, `video`, `attachment` → **предупреждение** (они будут проигнорированы)

**Метод API:** `sendAudio`

---

#### `document` - приложенный файл

**Требования:**
- `attachment` обязательно
- Остальные медиа-поля игнорируются

**Валидация:**
- Если `attachment` отсутствует → вернуть ошибку: `"Field 'attachment' is required for type 'document'"`
- Если есть `media`, `cover`, `video`, `audio` → **предупреждение** (они будут проигнорированы)

**Метод API:** `sendDocument`

---

### 6.3. Неподдерживаемые типы для Telegram

Следующие типы **не поддерживаются** для Telegram и должны возвращать ошибку:

| Тип        | Причина                                                          |
|------------|------------------------------------------------------------------|
| `article`  | Telegram не поддерживает формат article через Bot API (есть Telegraph, но это отдельный сервис) |
| `short`    | Нет отдельного типа для коротких видео (используется обычный `video`) |
| `story`    | Stories API пока не поддерживается в Bot API                     |
| `poll`     | Пока не реализовано (можно добавить в будущих версиях)           |

**Валидация:**
- Если `type` = один из вышеперечисленных → вернуть ошибку: `"Post type '{type}' is not supported for Telegram"`

---

## 7. Вопросы и предложения

### 7.1. Вопросы, требующие уточнения

#### 1. Naming: `attachment` vs `document`

**Вопрос:**  
Как лучше назвать поле для приложенных файлов?

**Варианты:**
- `attachment` - более универсальное название, используется в Discord, Email
- `document` - более специфичное для Telegram, соответствует методу `sendDocument`

**Рекомендация:**  
Использовать `attachment` в общем API, но маппить его на `document` для Telegram провайдера.

**Альтернатива:**  
Поддерживать оба поля как синонимы, где `attachment` имеет приоритет над `document`.

---

#### 2. Обработка длинного `body` для caption

**Вопрос:**  
Что делать, если `body` превышает 1024 символа для медиа-сообщений?

**Варианты:**
1. **Вернуть ошибку валидации** (строгий подход)
2. **Обрезать text до 1024** и добавить "..." (автоматическая обработка)
3. **Отправить два сообщения:** первое - медиа с частью caption, второе - остаток текста

**Рекомендация:**  
Вариант 1 (ошибка валидации) - более предсказуемое поведение, пусть клиент сам решает что делать с длинным текстом.

---

#### 3. Валидация форматов файлов

**Вопрос:**  
Должен ли микросервис валидировать форматы файлов (по расширению URL)?

**Варианты:**
1. **Не валидировать** - передать ответственность Telegram API
2. **Валидировать по расширению** - проверять `.jpg`, `.mp4`, `.mp3` и т.д.
3. **Валидировать через HEAD запрос** - проверять Content-Type и размер файла

**Рекомендация:**  
Вариант 1 (не валидировать) в MVP, т.к.:
- Telegram API сам вернет понятную ошибку
- Экономим время на загрузке/проверке файлов
- Уменьшаем нагрузку на микросервис

В будущих версиях можно добавить опциональную валидацию.

---

#### 4. Обработка смешанных медиа в media[]

**Вопрос:**  
Telegram позволяет смешивать фото и видео в одной медиа-группе. Нужна ли валидация типов элементов в `media[]`?

**Варианты:**
1. **Не валидировать** - передать Telegram API
2. **Валидировать, что все элементы - фото ИЛИ видео** (без смешивания)
3. **Разрешить смешивание** и указать это в документации

**Рекомендация:**  
Вариант 3 - разрешить смешивание, т.к. Telegram это поддерживает. Добавить примечание в документацию.

---

#### 5. Поддержка `scheduledAt` для Telegram

**Вопрос:**  
Telegram Bot API не поддерживает нативный scheduled posting. Что делать с параметром `scheduledAt`?

**Варианты:**
1. **Игнорировать** поле для Telegram (как и другие неподдерживаемые поля)
2. **Вернуть ошибку**, если поле указано
3. **Реализовать внутренний scheduler** в микросервисе (противоречит архитектуре stateless)

**Рекомендация:**  
Вариант 1 - игнорировать с предупреждением в логах. Scheduling должен реализовываться на уровне выше (в оркестраторе или планировщике задач).

---

### 7.2. Предложения по улучшению

#### 1. Добавить поддержку `voice` (голосовые сообщения)

**Описание:**  
Telegram поддерживает голосовые сообщения через метод `sendVoice` (формат OGG).

**Предложение:**
- Добавить поле `voice?: string` в DTO
- Добавить тип `VOICE = 'voice'` в enum
- При `type = 'auto'` проверять наличие `voice` после `media` и `attachment`, но до `audio`

**Приоритет:** Низкий (можно использовать `audio` для этого)

---

#### 2. Поддержка `animation` (GIF файлы)

**Описание:**  
Telegram различает обычные GIF (sendAnimation) и статичные изображения.

**Предложение:**
- Добавить поле `animation?: string` в DTO
- Добавить тип `ANIMATION = 'animation'` в enum  
- При `type = 'auto'` определять по расширению файла (.gif)

**Приоритет:** Средний

---

#### 3. Детализация ошибок валидации

**Предложение:**  
Для упрощения отладки, возвращать структурированные ошибки:

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "details": {
      "field": "media",
      "constraint": "minLength",
      "expected": 2,
      "actual": 1,
      "help": "Album must contain at least 2 media items"
    }
  }
}
```

---

#### 4. Режим предпросмотра (preview mode)

**Предложение:**  
Реализовать endpoint `POST /preview`, который:
- Принимает те же параметры, что и `/post`
- Выполняет всю валидацию
- Определяет тип сообщения (при `auto`)
- Формирует структуру запроса к Telegram API
- **НЕ отправляет** сообщение
- Возвращает информацию о том, что будет отправлено

**Польза:**  
Клиент может проверить корректность данных перед фактической отправкой.

---

#### 5. Поддержка Telegram-специфичных фич

**Описание:**  
Некоторые возможности Telegram можно вынести в `options`:

```typescript
interface TelegramOptions {
  // Уже поддерживаются:
  parseMode?: 'HTML' | 'Markdown' | 'MarkdownV2';
  disableNotification?: boolean;
  inlineKeyboard?: InlineKeyboardButton[][];
  disableWebPagePreview?: boolean;
  replyToMessageId?: number;
  protectContent?: boolean;
  
  // Предложения к добавлению:
  allowSendingWithoutReply?: boolean;
  messageThreadId?: number;  // Для тем (Topics)
  hasSpoiler?: boolean;      // Спойлер для медиа (Telegram 6.0+)
}
```

---

## 8. Этапы реализации

### Этап 1: Базовая поддержка новых полей
- [ ] Добавить `AUTO` в enum `PostType`
- [ ] Добавить поля `audio`, `attachment` в DTO
- [ ] Обновить валидацию
- [ ] Обновить документацию (PRD, API docs)

### Этап 2: Реализация логики `auto` для Telegram
- [ ] Реализовать метод определения типа сообщения
- [ ] Реализовать отправку через правильный метод API
- [ ] Добавить unit-тесты для логики определения типа

### Этап 3: Валидация для явных типов
- [ ] Реализовать валидацию для каждого типа (`post`, `image`, `video`, и т.д.)
- [ ] Добавить проверку обязательных полей
- [ ] Добавить предупреждения для игнорируемых полей
- [ ] Добавить unit-тесты для валидации

### Этап 4: Обработка edge cases
- [ ] Обработка длинного caption (> 1024 символов)
- [ ] Обработка неподдерживаемых типов
- [ ] Обработка игнорируемых полей (с предупреждениями)

### Этап 5: E2E тестирование
- [ ] Создать тестовый Telegram канал
- [ ] Протестировать все типы сообщений
- [ ] Протестировать режим `auto`
- [ ] Протестировать валидацию

### Этап 6: Документация и примеры
- [ ] Обновить API documentation с примерами
- [ ] Добавить примеры в README
- [ ] Создать Postman/Thunder Client коллекцию

---

## 9. Примеры использования

### Пример 1: Автоматическое определение (текст)

```bash
curl -X POST http://localhost:8080/api/v1/post \
  -H "Content-Type: application/json" \
  -d '{
    "platform": "telegram",
    "channel": "my_channel",
    "body": "Это обычное текстовое сообщение"
  }'
```

**Результат:** `sendMessage`

---

### Пример 2: Автоматическое определение (фото)

```bash
curl -X POST http://localhost:8080/api/v1/post \
  -H "Content-Type: application/json" \
  -d '{
    "platform": "telegram",
    "channel": "my_channel",
    "body": "Красивый закат",
    "cover": "https://example.com/sunset.jpg"
  }'
```

**Результат:** `sendPhoto`

---

### Пример 3: Автоматическое определение (медиа-группа)

```bash
curl -X POST http://localhost:8080/api/v1/post \
  -H "Content-Type: application/json" \
  -d '{
    "platform": "telegram",
    "channel": "my_channel",
    "body": "Фото с мероприятия",
    "media": [
      "https://example.com/photo1.jpg",
      "https://example.com/photo2.jpg",
      "https://example.com/photo3.jpg"
    ]
  }'
```

**Результат:** `sendMediaGroup`

---

### Пример 4: Явное указание типа

```bash
curl -X POST http://localhost:8080/api/v1/post \
  -H "Content-Type: application/json" \
  -d '{
    "platform": "telegram",
    "channel": "my_channel",
    "type": "video",
    "body": "Новый видео-урок",
    "video": "https://example.com/tutorial.mp4"
  }'
```

**Результат:** `sendVideo` (с валидацией наличия поля `video`)

---

### Пример 5: Аудио-сообщение

```bash
curl -X POST http://localhost:8080/api/v1/post \
  -H "Content-Type: application/json" \
  -d '{
    "platform": "telegram",
    "channel": "my_channel",
    "type": "auto",
    "body": "Новый выпуск подкаста",
    "audio": "https://example.com/episode-42.mp3"
  }'
```

**Результат:** `sendAudio`

---

### Пример 6: Приложенный файл

```bash
curl -X POST http://localhost:8080/api/v1/post \
  -H "Content-Type: application/json" \
  -d '{
    "platform": "telegram",
    "channel": "my_channel",
    "body": "Отчет за ноябрь",
    "attachment": "https://example.com/report-november.pdf"
  }'
```

**Результат:** `sendDocument`

---

## 10. Выводы

Данный план описывает полную реализацию постинга в Telegram с поддержкой:
- ✅ Автоматического определения типа сообщения (`type: auto`)
- ✅ Новых медиа-полей (`audio`, `attachment`)
- ✅ Приоритезированной логики определения метода API
- ✅ Валидации для явно заданных типов
- ✅ Обработки неиспользуемых/игнорируемых полей

**Требуется уточнение:**
1. Naming: `attachment` vs `document`
2. Обработка длинного caption (> 1024 символов)
3. Необходимость валидации форматов файлов

**Рекомендуемые улучшения:**
1. Поддержка `voice` и `animation`
2. Endpoint для preview/валидации
3. Детализация ошибок валидации
